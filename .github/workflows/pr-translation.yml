name: PR Translation Workflow

on:
  pull_request:
    types: [opened, synchronize, labeled, closed]
    paths: ['docs/**']
  pull_request_target:
    types: [opened, synchronize, labeled]
    paths: ['docs/**']
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # -------- è¯„è®ºæç¤ºï¼šé fork ç»Ÿè®¡ + è¯„è®º --------
  detect-docs-changes:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      has-docs-changes: ${{ steps.changes.outputs.any_changed }}
      total-files: ${{ steps.analyze.outputs.total_files }}
      operation-summary: ${{ steps.analyze.outputs.operation_summary }}
      skip-comment: ${{ steps.check-skip.outputs.skip }}
    steps:
      - name: Check if should skip
        id: check-skip
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.pull_request?.head?.sha;
            try {
              if (sha) {
                const { data: commit } = await github.rest.repos.getCommit({ ...context.repo, ref: sha });
                const msg = commit.commit.message || '';
                if (msg.includes('ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡æ¡£') || msg.includes('ğŸ”„ æ’¤å›ç¿»è¯‘')) {
                  core.setOutput('skip', 'true'); return;
                }
              }
            } catch(e) { core.warning(`check commit failed: ${e.message}`); }
            core.setOutput('skip', 'false');

      - uses: actions/checkout@v4
        if: steps.check-skip.outputs.skip != 'true'
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
          # filter: blob:none

      - name: Check for docs changes
        id: changes
        if: steps.check-skip.outputs.skip != 'true'
        uses: tj-actions/changed-files@v40
        with:
          files: |
            docs/**/*.{md,mdx}
            docs/**/_category_.yml
          files_ignore: |
            docs/zh-CN/**
            docs/ja/**
            docs/Spanish/**

      - name: Analyze changes
        id: analyze
        if: steps.changes.outputs.any_changed == 'true' && steps.check-skip.outputs.skip != 'true'
        run: |
          base_sha="${{ github.event.pull_request.base.sha }}"
          added=0; modified=0; deleted=0; renamed=0; renamed_mod=0
          if operations=$(git diff --name-status --find-renames=90 $base_sha..HEAD -- docs/ 2>/dev/null); then
            filtered=$(echo "$operations" | grep -E '\.(md|mdx)$|_category_\.yml$' | grep -v -E '(zh-CN|ja|Spanish)' || true)
            if [[ -n "$filtered" ]]; then
              while IFS=$'\t' read -r st file rest || [[ -n "$st" ]]; do
                [[ -z "$st" ]] && continue
                case "$st" in
                  A*) ((added++)) ;;
                  M*) ((modified++)) ;;
                  D*) ((deleted++)) ;;
                  R[0-9][0-9]) sim=${st#R}; if [ "$sim" -lt 100 ]; then ((renamed_mod++)); else ((renamed++)); fi ;;
                  R*) ((renamed++)) ;;
                esac
              done <<< "$filtered"
            fi
          fi
          total=$((added+modified+deleted+renamed+renamed_mod))
          echo "total_files=$total" >> $GITHUB_OUTPUT
          echo "operation_summary=æ–°å¢:$added ä¿®æ”¹:$modified åˆ é™¤:$deleted ç§»åŠ¨:$renamed ç§»åŠ¨+ä¿®æ”¹:$renamed_mod" >> $GITHUB_OUTPUT

  add-translation-comment:
    needs: detect-docs-changes
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.fork == false &&
      needs.detect-docs-changes.outputs.has-docs-changes == 'true' &&
      needs.detect-docs-changes.outputs.skip-comment != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Add translation comment (internal PR)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const total = '${{ needs.detect-docs-changes.outputs.total-files }}';
            const summary = '${{ needs.detect-docs-changes.outputs.operation-summary }}';
            let body = `## ğŸŒ æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´ - å¯è¿›è¡Œå¤šè¯­è¨€ç¿»è¯‘\n\n`;
            body += `**ç»Ÿè®¡ä¿¡æ¯:** å…± ${total} ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†\n`;
            body += `**æ“ä½œç±»å‹:** ${summary}\n\n`;
            body += `### ğŸš€ å¼€å§‹ç¿»è¯‘\nå›å¤ï¼š\`/translate all|zh|ja|es ...\`\n\n`;
            body += `### ğŸ”„ æ’¤å›ç¿»è¯‘\nå›å¤ï¼š\`/rollback translation\`\n\n`;
            body += `> ğŸ’¡ æç¤º: ç¿»è¯‘è€—æ—¶ä¸æ–‡ä»¶æ•°è¿‘ä¼¼çº¿æ€§`;
            await github.rest.issues.createComment({ owner, repo, issue_number: pr.number, body });

  # -------- è¯„è®ºæç¤ºï¼šfork PRï¼ˆå®‰å…¨ï¼Œä¸ checkout PR ä»£ç ï¼‰ --------
  add-translation-comment-target:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Comment with stats (fork-safe; no checkout)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const files = await github.paginate(github.rest.pulls.listFiles, { owner, repo, pull_number: pr.number, per_page: 100 });
            const wanted = files.filter(f => {
              const p=f.filename, inDocs=p.startsWith('docs/'),
                    okExt=/\.(md|mdx)$/.test(p)||/_category_\.yml$/.test(p),
                    ex=/(^|\/)(zh-CN|ja|Spanish)(\/|$)/.test(p);
              return inDocs && okExt && !ex;
            });
            let a=0,m=0,d=0,r=0; wanted.forEach(f=>{ if(f.status==='added')a++; else if(f.status==='modified')m++; else if(f.status==='removed')d++; else if(f.status==='renamed')r++; });
            const total=a+m+d+r;
            const summary=`æ–°å¢:${a} ä¿®æ”¹:${m} åˆ é™¤:${d} ç§»åŠ¨:${r} ç§»åŠ¨+ä¿®æ”¹:0`;
            let body = `## ğŸŒ æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´ - å¯è¿›è¡Œå¤šè¯­è¨€ç¿»è¯‘\n\n`;
            body += `**ç»Ÿè®¡ä¿¡æ¯:** å…± ${total} ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†\n`;
            body += `**æ“ä½œç±»å‹:** ${summary}\n\n`;
            body += `### ğŸš€ å¼€å§‹ç¿»è¯‘\nå›å¤ï¼š\`/translate all|zh|ja|es ...\`\nï¼ˆæ¥è‡ª fork çš„ PR å°†ç”±ç»´æŠ¤è€…æœºå™¨äººç›´æ¥æ¨åˆ°ä½ çš„ PR åˆ†æ”¯ï¼Œéœ€è¦å‹¾é€‰ **Allow edits by maintainers**ï¼‰\n\n`;
            body += `### ğŸ”„ æ’¤å›ç¿»è¯‘\nå›å¤ï¼š\`/rollback translation\`\n\n`;
            await github.rest.issues.createComment({ owner, repo, issue_number: pr.number, body });

  # -------- æ‰‹åŠ¨ç¿»è¯‘ï¼ˆåŒä»“åº“åˆ†æ”¯ï¼‰ --------
  manual-translate-internal:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/translate')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: context.payload.issue.number });
            core.setOutput('is_fork', String(pr.head.repo.full_name !== `${owner}/${repo}`));
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('head_ref', pr.head.ref);
      - name: Stop if this is a fork (handled by separate job)
        if: steps.pr.outputs.is_fork == 'true'
        run: echo "Fork PR will be handled by manual-translate-fork" && exit 0

      - name: Check permission of commenter
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo, user=context.payload.comment.user.login;
            const { data: p } = await github.rest.repos.getCollaboratorPermissionLevel({ owner, repo, username:user });
            if (!['admin','maintain'].includes(p.permission)) {
              await github.rest.issues.createComment({ owner, repo, issue_number: context.payload.issue.number, body:`âŒ @${user} æƒé™ä¸è¶³ï¼ˆéœ€è¦ admin/maintainï¼‰`});
              core.setFailed('no permission');
            }

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Parse translation command
        id: parse
        run: |
          c="${{ github.event.comment.body }}"
          if [[ "$c" == *"/translate all"* ]]; then L="zh-CN ja es"; else
            L=""; [[ "$c" == *" zh"* ]] && L="$L zh-CN"; [[ "$c" == *" ja"* ]] && L="$L ja"; [[ "$c" == *" es"* ]] && L="$L es"
          fi
          L=$(echo $L | xargs); echo "languages=$L" >> $GITHUB_OUTPUT

      - name: Install deps for translator
        run: npm install @anthropic-ai/sdk --no-save --legacy-peer-deps

      - name: Run translation (internal)
        env:
          TRANSLATION_API_KEY: ${{ secrets.TRANSLATION_API_KEY }}
          TARGET_LANGUAGES: ${{ steps.parse.outputs.languages }}
        run: |
          [ -z "$TRANSLATION_API_KEY" ] && echo "missing key" && exit 1
          node .github/scripts/translate.js

      - name: Commit & push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action Bot"
          if [ -n "$(git status --porcelain docs/)" ]; then
            git add docs/
            git commit -m "ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡æ¡£" -m "Triggered by @${{ github.event.comment.user.login }}"
            git push
          else
            echo "No changes."
          fi

  # -------- æ‰‹åŠ¨ç¿»è¯‘ï¼ˆfork åˆ†æ”¯ï¼Œæ–¹æ¡ˆ Bï¼šç›´æ¥ push åˆ°è´¡çŒ®è€…åˆ†æ”¯ï¼‰ --------
  manual-translate-fork:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/translate')
    runs-on: ubuntu-latest
    steps:
      - name: Read PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const num = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: num });
            core.setOutput('is_fork', String(pr.head.repo.full_name !== `${owner}/${repo}`));
            core.setOutput('fork_full_name', pr.head.repo.full_name);
            core.setOutput('fork_owner', pr.head.repo.owner.login);
            core.setOutput('fork_repo', pr.head.repo.name);
            core.setOutput('fork_ref', pr.head.ref);
            core.setOutput('maintainer_can_modify', String(!!pr.maintainer_can_modify));

      - name: Only run for fork PR
        if: steps.pr.outputs.is_fork != 'true'
        run: echo "Not a fork PR, skip (handled by internal job)" && exit 0

      - name: Check commenter permission
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo, user=context.payload.comment.user.login;
            const { data: p } = await github.rest.repos.getCollaboratorPermissionLevel({ owner, repo, username:user });
            if (!['admin','maintain'].includes(p.permission)) {
              await github.rest.issues.createComment({ owner, repo, issue_number: context.payload.issue.number, body:`âŒ @${user} æƒé™ä¸è¶³ï¼ˆéœ€è¦ admin/maintainï¼‰`});
              core.setFailed('no permission');
            }

      - name: Ensure "Allow edits by maintainers" is enabled
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            if ('${{ steps.pr.outputs.maintainer_can_modify }}' !== 'true') {
              await github.rest.issues.createComment({
                owner, repo, issue_number: context.payload.issue.number,
                body: 'âš ï¸ éœ€è¦ä½œè€…åœ¨ PR å‹¾é€‰ **Allow edits by maintainers**ï¼Œå¦åˆ™æ— æ³•å°†ç¿»è¯‘ç»“æœæ¨å›ä½ çš„åˆ†æ”¯ã€‚'
              });
              core.setFailed('maintainer_can_modify is false');
            }

      # 1) æ£€å‡ºä½ è‡ªå·±çš„ä»“åº“ï¼ˆåªä¸ºè·å–å—ä¿¡ä»»çš„è„šæœ¬ï¼‰
      - name: Checkout base repo (trusted code only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: base

      # 2) å‡†å¤‡ä¸€ä¸ªä¸´æ—¶å·¥ä½œæ ‘ï¼Œç”¨ PAT æ‹‰å–è´¡çŒ®è€… fork çš„è¯¥åˆ†æ”¯
      - name: Prepare fork worktree
        env:
          TRANSLATION_PAT: ${{ secrets.TRANSLATION_PAT }}
        run: |
          set -e
          [ -z "$TRANSLATION_PAT" ] && echo "âŒ TRANSLATION_PAT missing" && exit 1
          mkdir -p fork
          cd fork
          git init
          git config user.email "action@github.com"
          git config user.name "GitHub Action Bot"
          git remote add origin https://${TRANSLATION_PAT}@github.com/${{ steps.pr.outputs.fork_full_name }}.git
          git fetch --depth=1 origin ${{ steps.pr.outputs.fork_ref }}
          git checkout -b pr-branch FETCH_HEAD
          # ä»…ä½œä¸ºæ–‡ä»¶è½½ä½“ï¼Œä¸è¿è¡Œä»»ä½• fork é‡Œçš„è„šæœ¬

      - name: Setup Node.js (run trusted translator)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Parse translation command
        id: parse
        run: |
          c="${{ github.event.comment.body }}"
          if [[ "$c" == *"/translate all"* ]]; then L="zh-CN ja es"; else
            L=""; [[ "$c" == *" zh"* ]] && L="$L zh-CN"; [[ "$c" == *" ja"* ]] && L="$L ja"; [[ "$c" == *" es"* ]] && L="$L es"
          fi
          L=$(echo $L | xargs); echo "languages=$L" >> $GITHUB_OUTPUT

      - name: Install deps for translator
        working-directory: base
        run: npm install @anthropic-ai/sdk --no-save --legacy-peer-deps

      - name: Run translation against fork worktree
        env:
          TRANSLATION_API_KEY: ${{ secrets.TRANSLATION_API_KEY }}
          TARGET_LANGUAGES: ${{ steps.parse.outputs.languages }}
          WORKTREE_DIR: ${{ github.workspace }}/fork
        run: |
          set -e
          [ -z "$TRANSLATION_API_KEY" ] && echo "âŒ ç¼ºå°‘ TRANSLATION_API_KEY" && exit 1
          # è¿›å…¥å¯ä¿¡ä»£ç ç›®å½•æ‰§è¡Œè„šæœ¬ï¼Œä½†æŠŠ fork å·¥ä½œæ ‘è·¯å¾„ä½œä¸ºè¾“å…¥/è¾“å‡ºä½ç½®
          cd base
          node .github/scripts/translate.js "$WORKTREE_DIR"

      - name: Commit & push back to contributor branch (PAT)
        env:
          TRANSLATION_PAT: ${{ secrets.TRANSLATION_PAT }}
        run: |
          set -e
          cd fork
          if [ -n "$(git status --porcelain docs/)" ]; then
            git add docs/
            git commit -m "ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡æ¡£" -m "Triggered by @${{ github.event.comment.user.login }}"
            git push origin HEAD:${{ steps.pr.outputs.fork_ref }}
            echo "âœ… Changes pushed to ${{ steps.pr.outputs.fork_full_name }}:${{ steps.pr.outputs.fork_ref }}"
          else
            echo "â„¹ï¸ No docs changes to commit."
          fi

      - name: Leave result comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.createComment({
              owner, repo, issue_number: context.payload.issue.number,
              body: 'âœ… å·²å°†ç¿»è¯‘ç»“æœç›´æ¥æ¨é€åˆ°ä½ çš„ PR åˆ†æ”¯ï¼ˆforkï¼‰ã€‚å¦‚éœ€æ’¤å›è¯·å‘ŠçŸ¥ç»´æŠ¤è€…ã€‚'
            })

  # -------- æ’¤å›ï¼ˆåªé’ˆå¯¹åŒä»“åº“åˆ†æ”¯ï¼›fork çš„æ’¤å›é€šå¸¸ç”±ä½œè€…è‡ªè¡Œå¤„ç†ï¼‰ --------
  rollback-translation:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/rollback translation')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: context.payload.issue.number });
            core.setOutput('is_fork', String(pr.head.repo.full_name !== `${owner}/${repo}`));
            core.setOutput('head_ref', pr.head.ref);

      - name: Stop for fork PR (ask author to rollback)
        if: steps.pr.outputs.is_fork == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.createComment({
              owner, repo, issue_number: context.payload.issue.number,
              body: 'âš ï¸ å½“å‰ä¸º fork PRï¼Œæ’¤å›è¯·ç”±ä½œè€…åœ¨å…¶åˆ†æ”¯ä¸Šæ‰§è¡Œæˆ–å…³é—­ PRã€‚'
            });

      - name: Checkout (internal PR)
        if: steps.pr.outputs.is_fork != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rollback commit (internal PR)
        if: steps.pr.outputs.is_fork != 'true'
        run: |
          set -e
          git config user.email "action@github.com"
          git config user.name "GitHub Action Bot"
          # è¿™é‡Œå¯ä»¥æ ¹æ®ä½ çš„å…ƒæ•°æ®å®ç°ç²¾å‡†å›æ»šï¼›ç®€åŒ–ç¤ºä¾‹ï¼šæ’¤é”€æœ€è¿‘ä¸€æ¬¡ç¿»è¯‘æäº¤
          last=$(git log --grep="ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡æ¡£" --format=%H -n 1 || true)
          if [ -n "$last" ]; then
            git revert --no-edit "$last"
            git push
            echo "âœ… Reverted $last"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°ç¿»è¯‘æäº¤ï¼Œè·³è¿‡"
          fi

  # -------- åˆå¹¶åçš„å°è¯„è®º --------
  post-merge-comment:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Comment after merge
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const body = `â¤ï¸ Great PR @${pr.user.login} â¤ï¸`;
            await github.rest.issues.createComment({ owner, repo, issue_number: pr.number, body });
