name: PR Translation Workflow

on:
  pull_request:
    types: [opened, synchronize, labeled, closed]
    paths: ['docs/**']
  pull_request_target:
    types: [opened, synchronize, labeled, reopened, closed]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Ê£ÄÊµã PR ‰∏≠ÁöÑÊñáÊ°£ÂèòÊõ¥
  detect-docs-changes:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    concurrency:
      group: pr-translation-detect-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      pull-requests: write
      issues: write
    outputs:
      has-docs-changes: ${{ steps.changes.outputs.any_changed }}
      changed-files: ${{ steps.analyze.outputs.changed_files }}
      total-files: ${{ steps.analyze.outputs.total_files }}
      operation-summary: ${{ steps.analyze.outputs.operation_summary }}
      skip-comment: ${{ steps.check-skip.outputs.skip }}
    steps:
      - name: Check if should skip (via last PR commit message)
        id: check-skip
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            try {
              const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number });
              const [headOwner, headRepo] = pr.head.repo.full_name.split('/');
              const headSha = pr.head.sha;
              const { data: commit } = await github.rest.repos.getCommit({ owner: headOwner, repo: headRepo, ref: headSha });
              const message = commit?.commit?.message || '';
              if (
                message.includes('üåç Ëá™Âä®ÁøªËØëÊñáÊ°£') ||
                message.includes('[TRANSLATION_COMMIT]: true')
              ) {
                core.info('Ê£ÄÊµãÂà∞ÁøªËØë commitÔºåË∑≥ËøáÊñáÊ°£ÂèòÊõ¥Ê£ÄÊµãÂíåËØÑËÆ∫');
                core.setOutput('skip', 'true');
                return;
              }
            } catch (e) {
              core.warning('ËØªÂèñ PR Êèê‰∫§‰ø°ÊÅØÂ§±Ë¥•Ôºö' + e.message);
            }
            core.setOutput('skip', 'false');

      - uses: actions/checkout@v4
        if: steps.check-skip.outputs.skip != 'true'
        with:
          fetch-depth: 2
          fetch-tags: false
          sparse-checkout: |
            docs
          sparse-checkout-cone-mode: true

      - name: Check for docs changes
        id: changes
        if: steps.check-skip.outputs.skip != 'true'
        uses: tj-actions/changed-files@v40
        with:
          files: |
            docs/**/*.{md,mdx}
            docs/**/_category_.yml
          files_ignore: |
            docs/zh-CN/**
            docs/ja/**
            docs/es/**

      - name: Ensure base commit is available
        if: steps.changes.outputs.any_changed == 'true' && steps.check-skip.outputs.skip != 'true'
        run: |
          git fetch --depth=1 origin ${{ github.event.pull_request.base.sha }}

      - name: Analyze changes
        id: analyze
        if: steps.changes.outputs.any_changed == 'true' && steps.check-skip.outputs.skip != 'true'
        run: |
          echo "üìä ÂàÜÊûêÊñáÊ°£ÂèòÊõ¥..."
          base_sha="${{ github.event.pull_request.base.sha }}"
          echo "üîç Âü∫Á°ÄSHA: $base_sha"

          added_count=0
          modified_count=0
          deleted_count=0
          renamed_count=0
          renamed_modified_count=0
          all_files=""

          if operations=$(git diff --name-status --find-renames=90 $base_sha..HEAD -- docs/ 2>/dev/null); then
            filtered_operations=$(echo "$operations" | grep -E '\.(md|mdx)$|_category_\.yml$' | grep -v -E '(zh-CN|ja|es)' || true)
            if [[ -n "$filtered_operations" ]]; then
              while IFS=$'\t' read -r status file rest || [[ -n "$status" ]]; do
                [[ -z "$status" ]] && continue
                case "$status" in
                  A*) added_count=$((added_count + 1)); all_files="$all_files$file " ;;
                  M*) modified_count=$((modified_count + 1)); all_files="$all_files$file " ;;
                  D*) deleted_count=$((deleted_count + 1)); all_files="$all_files$file " ;;
                  R[0-9][0-9])
                    similarity=${status#R}
                    if [ "$similarity" -lt 100 ]; then
                      renamed_modified_count=$((renamed_modified_count + 1))
                    else
                      renamed_count=$((renamed_count + 1))
                    fi
                    all_files="$all_files$file "
                    [[ -n "$rest" ]] && all_files="$all_files$rest "
                    ;;
                  R*) renamed_count=$((renamed_count + 1)); all_files="$all_files$file "; [[ -n "$rest" ]] && all_files="$all_files$rest " ;;
                esac
              done <<< "$filtered_operations"
            fi
          fi

          total_count=$((added_count + modified_count + deleted_count + renamed_count + renamed_modified_count))
          echo "changed_files=$all_files" >> $GITHUB_OUTPUT
          echo "total_files=$total_count" >> $GITHUB_OUTPUT
          echo "operation_summary=Êñ∞Â¢û:$added_count ‰øÆÊîπ:$modified_count Âà†Èô§:$deleted_count ÁßªÂä®:$renamed_count ÁßªÂä®+‰øÆÊîπ:$renamed_modified_count" >> $GITHUB_OUTPUT

  # Ê∑ªÂä†ÁøªËØëÊèêÁ§∫ËØÑËÆ∫
  add-translation-comment:
    if: github.event_name == 'pull_request_target' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    concurrency:
      group: pr-translation-comment-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      pull-requests: write
      issues: write
      contents: read
    steps:
      - name: Check if should skip (via last PR commit message)
        id: check-skip
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            try {
              const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number });
              const [headOwner, headRepo] = pr.head.repo.full_name.split('/');
              const headSha = pr.head.sha;
              const { data: commit } = await github.rest.repos.getCommit({ owner: headOwner, repo: headRepo, ref: headSha });
              const message = commit?.commit?.message || '';
              if (
                message.includes('üåç Ëá™Âä®ÁøªËØëÊñáÊ°£') ||
                message.includes('[TRANSLATION_COMMIT]: true')
              ) {
                core.info('Ê£ÄÊµãÂà∞ÁøªËØë commitÔºåË∑≥ËøáËØÑËÆ∫');
                core.setOutput('skip', 'true');
                return;
              }
            } catch (e) {
              core.warning('ËØªÂèñ PR Êèê‰∫§‰ø°ÊÅØÂ§±Ë¥•Ôºö' + e.message);
            }
            core.setOutput('skip', 'false');

      - name: Analyze docs changes (fast via API)
        id: analyze
        if: steps.check-skip.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;
            let page = 1, files = [];
            while (true) {
              const { data } = await github.rest.pulls.listFiles({
                owner, repo, pull_number: pr_number, per_page: 100, page
              });
              if (!data.length) break;
              files = files.concat(data);
              page++;
            }
            const isDocs = f =>
              /^docs\//.test(f.filename) &&
              !/^docs\/(zh-CN|ja|es)\//.test(f.filename) &&
              (/\.(md|mdx)$/.test(f.filename) || /_category_\.yml$/.test(f.filename));
            const picked = files.filter(isDocs);
            let added=0, modified=0, deleted=0, renamed=0, renamed_modified=0;
            for (const f of picked) {
              if (f.status === 'added') added++;
              else if (f.status === 'modified') modified++;
              else if (f.status === 'removed') deleted++;
              else if (f.status === 'renamed') {
                if ((f.changes ?? 0) > 0) renamed_modified++; else renamed++;
              }
            }
            const total = picked.length;
            core.setOutput('total_files', String(total));
            core.setOutput('operation_summary', `Êñ∞Â¢û:${added} ‰øÆÊîπ:${modified} Âà†Èô§:${deleted} ÁßªÂä®:${renamed} ÁßªÂä®+‰øÆÊîπ:${renamed_modified}`);

      - name: Add translation comment
        if: steps.check-skip.outputs.skip != 'true' && steps.analyze.outputs.total_files != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const totalFiles = '${{ steps.analyze.outputs.total_files }}';
            const operationSummary = '${{ steps.analyze.outputs.operation_summary }}';
            let comment = `## üåç Ê£ÄÊµãÂà∞ÊñáÊ°£ÂèòÊõ¥ - ÂèØËøõË°åÂ§öËØ≠Ë®ÄÁøªËØë\n\n`;
            comment += `**ÁªüËÆ°‰ø°ÊÅØ:** ÂÖ± ${totalFiles} ‰∏™Êñá‰ª∂ÈúÄË¶ÅÂ§ÑÁêÜ\n`;
            comment += `**Êìç‰ΩúÁ±ªÂûã:** ${operationSummary}\n\n`;
            comment += `### üöÄ ÂºÄÂßãÁøªËØë\n`;
            comment += `Âú®Ê≠§ËØÑËÆ∫ÂõûÂ§ç‰ª•‰∏ãÂëΩ‰ª§‰πã‰∏ÄÔºö\n\n`;
            comment += `- \`/translate all\` - ÁøªËØëÊâÄÊúâÂèòÊõ¥Âà∞ÊâÄÊúâËØ≠Ë®Ä (‰∏≠Êñá„ÄÅÊó•Êñá„ÄÅË•øÁè≠ÁâôËØ≠)\n`;
            comment += `- \`/translate zh\` - ‰ªÖÁøªËØëÂà∞‰∏≠Êñá\n`;
            comment += `- \`/translate ja\` - ‰ªÖÁøªËØëÂà∞Êó•Êñá\n`;
            comment += `- \`/translate es\` - ‰ªÖÁøªËØëÂà∞Ë•øÁè≠ÁâôËØ≠\n`;
            comment += `- \`/translate zh ja\` - ÁøªËØëÂà∞‰∏≠ÊñáÂíåÊó•Êñá\n`;
            comment += `- \`/translate zh es\` - ÁøªËØëÂà∞‰∏≠ÊñáÂíåË•øÁè≠ÁâôËØ≠\n\n`;
            comment += `> ËØëÊñáÂ∞ÜÊèê‰∫§Âà∞ base ‰ªìÂ∫ìÂàÜÊîØ \`auto-translate/pr-<PRÂè∑>\` Âπ∂ÊâìÂºÄ/Â§çÁî®‰∏Ä‰∏™ÁøªËØë PRÔºåÂéü PR ‰∏ç‰ºöË¢´ÁøªËØëÊèê‰∫§Ê±°ÊüìÔºå‰πü‰∏ç‰ºöÈòªÂ°ûÂêàÂπ∂„ÄÇ`;
            await github.rest.issues.createComment({ owner, repo, issue_number: pull_number, body: comment });

  # ‚Äî‚Äî ÊâãÂä®Ëß¶ÂèëÁøªËØë ‚Äî‚Äî #
  manual-translate:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/translate')
    runs-on: ubuntu-latest
    timeout-minutes: 180
    concurrency:
      group: pr-translation-run-${{ github.event.issue.number }}
      cancel-in-progress: false   # ‚≠ê ‰∏çË¢´ÂêéÁª≠‰∫ã‰ª∂ÊâìÊñ≠
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    outputs:
      translation-completed: ${{ steps.check-completion.outputs.completed }}
      has-changes: ${{ steps.check-completion.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
          fetch-tags: false

      - name: Get PR context (head repo/ref & permissions)
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: issue_number });
            core.setOutput('head-repo', pr.head.repo.full_name);
            core.setOutput('head-ref', pr.head.ref);
            core.setOutput('base-sha', pr.base.sha);
            core.setOutput('head-sha', pr.head.sha);
            core.setOutput('is-fork', pr.head.repo.fork ? 'true' : 'false');
            core.setOutput('maintainer-can-modify', pr.maintainer_can_modify ? 'true' : 'false');
            core.setOutput('base-ref', pr.base.ref);

      - name: Add start comment
        id: start-comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const username = context.payload.comment.user.login;
            const comment = `## üîÑ ÂºÄÂßãÁøªËØë‰ªªÂä°\n\n` +
              `**Ëß¶ÂèëËÄÖ:** @${username}\n` +
              `**ÂºÄÂßãÊó∂Èó¥:** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n` +
              `**ÂëΩ‰ª§:** \`${context.payload.comment.body.trim()}\`\n\n` +
              `‚è≥ Ê≠£Âú®Ê£ÄÊü•ÊùÉÈôêÂíåÂàùÂßãÂåñÁøªËØëÁéØÂ¢É...\n\n` +
              `> üîç ÁøªËØëÂÆåÊàêÂêé‰ºöÂú®Ê≠§Êõ¥Êñ∞ËØ¶ÁªÜÊä•Âëä`;
            const res = await github.rest.issues.createComment({ owner, repo, issue_number, body: comment });
            return res.data.id

      - name: Check user permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const username = context.payload.comment.user.login;
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({ owner, repo, username });
            const allowed = ['admin','maintain'].includes(permission.permission);
            if (!allowed) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: context.payload.issue.number,
                body: `## ‚ùå ÊùÉÈôê‰∏çË∂≥\n\n@${username} ‰ªÖÁÆ°ÁêÜÂëò/Áª¥Êä§ËÄÖÂèØËß¶ÂèëÁøªËØë„ÄÇ\n\n**ÂΩìÂâçÊùÉÈôê:** \`${permission.permission}\``
              });
              core.setFailed('ÊùÉÈôê‰∏çË∂≥'); return;
            }
            core.setOutput('has_permission','true');

      # Ê£ÄÂá∫ PR headÔºàÊµÖÂÖãÈöÜ + Á®ÄÁñèÔºâ
      - name: Checkout PR head (fast)
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr-info.outputs.head-repo }}
          ref: ${{ steps.pr-info.outputs.head-ref }}
          fetch-depth: 2
          fetch-tags: false
          sparse-checkout: |
            docs
          sparse-checkout-cone-mode: true
          filter: blob:none

      - name: Checkout trusted scripts (base repo)
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          fetch-depth: 1
          fetch-tags: false
          sparse-checkout: |
            .github/scripts
          sparse-checkout-cone-mode: true
          filter: blob:none
          path: _trusted

      - name: Record BEFORE SHA
        if: steps.check-permissions.outputs.has_permission == 'true'
        run: |
          BEFORE_TRANSLATION_SHA=$(git rev-parse HEAD)
          echo "BEFORE_TRANSLATION_SHA=$BEFORE_TRANSLATION_SHA" >> $GITHUB_ENV
          echo "üìå ËÆ∞ÂΩïÁøªËØëÂâçÁöÑSHA: $BEFORE_TRANSLATION_SHA"

      - name: Ensure base SHA is available for diff
        if: steps.check-permissions.outputs.has_permission == 'true'
        run: |
          git fetch --depth=1 origin ${{ steps.pr-info.outputs.base-sha }}

      - name: Setup Node.js
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Parse translation command
        if: steps.check-permissions.outputs.has_permission == 'true'
        id: parse
        run: |
          comment="${{ github.event.comment.body }}"
          echo "üîç Ëß£ÊûêÁøªËØëÂëΩ‰ª§: $comment"
          if [[ "$comment" == *"/translate all"* ]]; then
            languages="zh-CN ja es"
          else
            languages=""
            [[ "$comment" == *" zh"* ]] && languages="$languages zh-CN"
            [[ "$comment" == *" ja"* ]] && languages="$languages ja"
            [[ "$comment" == *" es"* ]] && languages="$languages es"
          fi
          languages=$(echo $languages | xargs)
          echo "languages=$languages" >> $GITHUB_OUTPUT
          echo "üéØ ÊúÄÁªàÁøªËØëËØ≠Ë®Ä: $languages"

      - name: Cache npm
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-anthropic-sdk-v1
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        if: steps.check-permissions.outputs.has_permission == 'true'
        run: |
          echo "üì¶ ÂÆâË£ÖÁøªËØë‰æùËµñ..."
          npm install @anthropic-ai/sdk --no-save --legacy-peer-deps

      - name: Run translation
        if: steps.check-permissions.outputs.has_permission == 'true'
        env:
          TRANSLATION_API_KEY: ${{ secrets.TRANSLATION_API_KEY }}
          TARGET_LANGUAGES: ${{ steps.parse.outputs.languages }}
          BASE_SHA: ${{ steps.pr-info.outputs.base-sha }}
        run: |
          echo "üöÄ ÂºÄÂßãÁøªËØë‰ªªÂä°..."
          echo "ÁõÆÊ†áËØ≠Ë®Ä: $TARGET_LANGUAGES"
          echo "Âü∫Á°ÄSHA: $BASE_SHA"
          if [ -z "$TRANSLATION_API_KEY" ]; then
            echo "‚ùå Áº∫Â∞ë TRANSLATION_API_KEY"
            exit 1
          fi
          node _trusted/.github/scripts/translate.js

      # ‚≠ê Â∞ÜËØëÊñáÊé®ÈÄÅÂà∞ base ‰ªìÂ∫ìÁã¨Á´ãÂàÜÊîØÔºàÂè™Êèê‰∫§ÊîπÂä®ÁöÑÊñá‰ª∂ÔºâÔºåÂπ∂ÂàõÂª∫/Êõ¥Êñ∞ÁøªËØë PR
      - name: Prepare translation branch in base repo
        if: steps.check-permissions.outputs.has_permission == 'true'
        id: prep-branch
        env:
          TRANSLATION_PAT: ${{ secrets.TRANSLATION_PAT }}
          BASE_REPO: ${{ github.repository }}                 # owner/repo
          BASE_REF: ${{ steps.pr-info.outputs.base-ref }}     # e.g. main
          PR_NUMBER: ${{ github.event.issue.number }}
          LANGUAGES: ${{ steps.parse.outputs.languages }}
        run: |
          set -e
          echo "üîß ÂáÜÂ§áÂú® base ‰ªìÂ∫ìÂàõÂª∫/Êõ¥Êñ∞ÁøªËØëÂàÜÊîØ..."

          BRANCH="auto-translate/pr-${PR_NUMBER}"
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT

          WORKDIR=$(mktemp -d)
          echo "WORKDIR=$WORKDIR"

          TOKEN="${TRANSLATION_PAT:-${GITHUB_TOKEN}}"
          if [ -z "$TOKEN" ]; then
            echo "‚ùå Áº∫Â∞ëÂèØÂÜôÂá≠ÊçÆ"
            exit 1
          fi
          REMOTE_URL="https://${TOKEN}@github.com/${BASE_REPO}.git"

          git config --global init.defaultBranch main
          git clone --depth=1 "$REMOTE_URL" "$WORKDIR/repo"
          cd "$WORKDIR/repo"
          git fetch --depth=1 origin "$BASE_REF"
          git checkout "$BASE_REF"

          # ‚úÖ ÈïúÂÉè‰∏âÁßçËØ≠Ë®ÄÁõÆÂΩïÔºàÂê´Âà†Èô§ÔºâÔºåÂπ∂Èò≤Ê≠¢ symlink Ë∂äÁïå
          rsync -a --delete --safe-links --copy-dirlinks \
            --include='docs/' \
            --include='docs/zh-CN/***' \
            --include='docs/ja/***' \
            --include='docs/es/***' \
            --exclude='*' \
            "$GITHUB_WORKSPACE/" .

          git config user.email "action@github.com"
          git config user.name "GitHub Action Bot"

          # Âè™ÂØπËØ≠Ë®ÄÁõÆÂΩïËøõË°å addÔºà‰∏çÂ≠òÂú®ÂàôÂøΩÁï•Ôºâ
          git add docs/zh-CN docs/ja docs/es 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è ÈïúÂÉèÂêéÊó†ÂèòÂåñ"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            git commit \
              -m "üåç Ëá™Âä®ÁøªËØëÊñáÊ°£ for #${PR_NUMBER}" \
              -m "Languages: ${LANGUAGES}" \
              -m "Base: ${BASE_REF}" \
              -m "Source PR: #${PR_NUMBER}" \
              -m "[TRANSLATION_COMMIT]: true"
            git push origin HEAD:"$BRANCH"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Create or update translation PR
        if: steps.check-permissions.outputs.has_permission == 'true' && env.HAS_CHANGES == 'true'
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const base = '${{ steps.pr-info.outputs.base-ref }}';
            const head = '${{ steps.prep-branch.outputs.BRANCH }}'; // auto-translate/pr-<PRÂè∑>
            const title = `üåç Docs translations for #${issue_number}`;
            const body = [
              `This PR contains machine translations for docs changed in #${issue_number}.`,
              '',
              '**Notes**:',
              '- Independent from the source PR; merge when translations look good.',
              '- Source PR updates will not interrupt this translation run.',
              '',
              `> Created by GitHub Actions (branch: \`${head}\`)`
            ].join('\n');

            // Â§çÁî®Â∑≤Â≠òÂú®ÁöÑÁøªËØë PRÔºåÂê¶ÂàôÊñ∞Âª∫
            const list = await github.rest.pulls.list({
              owner, repo, state: 'open', head: `${owner}:${head}`, base
            });

            let prNumber;
            if (list.data.length > 0) {
              const pr = list.data[0];
              prNumber = pr.number;
              await github.rest.issues.update({ owner, repo, issue_number: pr.number, title });
              try { await github.rest.issues.addLabels({ owner, repo, issue_number: pr.number, labels: ['auto-translation'] }); } catch {}
              core.info(`Updated existing translation PR #${pr.number}`);
            } else {
              const pr = await github.rest.pulls.create({ owner, repo, base, head, title, body, maintainer_can_modify: true });
              prNumber = pr.data.number;
              try { await github.rest.issues.addLabels({ owner, repo, issue_number: pr.data.number, labels: ['auto-translation'] }); } catch {}
              core.info(`Created translation PR #${pr.data.number}`);
            }
            core.setOutput('pr-number', String(prNumber));

      - name: Save translation metadata to source PR
        if: steps.check-permissions.outputs.has_permission == 'true' && env.HAS_CHANGES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.issue.number;
            const body = `<!-- TRANSLATION_METADATA
            ${JSON.stringify({
              source_pr: pr_number,
              translation_branch: '${{ steps.prep-branch.outputs.BRANCH }}',
              translation_pr: '${{ steps.create-pr.outputs.pr-number }}',
              languages: '${{ steps.parse.outputs.languages }}',
              before_sha: process.env.BEFORE_TRANSLATION_SHA,
              timestamp: new Date().toISOString(),
              triggered_by: '${{ github.event.comment.user.login }}'
            })}
            -->`;
            await github.rest.issues.createComment({ owner, repo, issue_number: pr_number, body });

      - name: Update completion comment
        if: always() && steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const commentId = '${{ steps.start-comment.outputs.result }}';
            const success = '${{ job.status }}' === 'success';
            const languages = '${{ steps.parse.outputs.languages }}';
            const hasChanges = process.env.HAS_CHANGES === 'true';
            const prNum = '${{ steps.create-pr.outputs.pr-number }}' || 'N/A';
            const beforeSha = process.env.BEFORE_TRANSLATION_SHA || 'N/A';
            const branch = '${{ steps.prep-branch.outputs.BRANCH }}' || 'N/A';

            let status, icon;
            if (success && hasChanges) { status='ÁøªËØëÂÆåÊàê'; icon='‚úÖ'; }
            else if (success && !hasChanges) { status='Êó†ÈúÄÁøªËØë'; icon='‚ÑπÔ∏è'; }
            else { status='ÁøªËØëÂ§±Ë¥•'; icon='‚ùå'; }

            let comment = `## ${icon} ${status}\n\n`;
            comment += `**ÁøªËØëËØ≠Ë®Ä:** ${languages || 'Êó†'}\n`;
            comment += `**ÂÆåÊàêÊó∂Èó¥:** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n`;
            comment += `**Ëß¶ÂèëËÄÖ:** @${{ github.event.comment.user.login }}\n`;
            comment += `**ÁøªËØëÂàÜÊîØ:** \`${branch}\`\n`;
            if (success && hasChanges && prNum !== 'N/A') {
              comment += `**ÁøªËØë PR:** #${prNum}\n`;
              comment += `**ÁøªËØëÂâçSHA:** \`${beforeSha}\`\n\n`;
              comment += `### üéâ ÁøªËØëÊàêÂäüÔºÅ\n\nËØëÊñáÂ∑≤Êèê‰∫§Âà∞Áã¨Á´ã PRÔºàËßÅ‰∏äÔºâÔºåÂèØÁã¨Á´ãÂÆ°Ê†∏‰∏éÂêàÂπ∂„ÄÇ\n`;
            } else if (success && !hasChanges) {
              comment += `### üîç Ê≤°ÊúâÊ£ÄÊµãÂà∞ÈúÄË¶ÅÁøªËØëÁöÑÂÜÖÂÆπ\n\nÂèØËÉΩÂéüÂõ†ÔºöÁõÆÊ†áËØ≠Ë®ÄÂ∑≤ÊúÄÊñ∞ÔºåÊàñÊó†ÊúâÊïàÊñáÊ°£ÂèòÊõ¥„ÄÇ\n`;
            } else {
              comment += `### üíî ÁøªËØëÂ§±Ë¥•\n\nËØ∑Êü•Áúã [Â∑•‰ΩúÊµÅÊó•Âøó](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})„ÄÇ\n`;
            }
            comment += `\n---\n> ü§ñ Áî± GitHub Actions Ëá™Âä®ÁîüÊàê | [Êü•ÁúãÂ∑•‰ΩúÊµÅ](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})`;
            try {
              await github.rest.issues.updateComment({ owner, repo, comment_id: commentId, body: comment });
            } catch {
              await github.rest.issues.createComment({ owner, repo, issue_number: issue_number, body: comment });
            }

      - name: Check completion status
        id: check-completion
        if: always() && steps.check-permissions.outputs.has_permission == 'true'
        run: |
          if [ "${{ job.status }}" = "success" ] && [ "$HAS_CHANGES" = "true" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi