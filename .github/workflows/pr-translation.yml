name: PR Translation Workflow

on:
  pull_request:
    types: [opened, synchronize, labeled, closed]
    paths: ['docs/**']
  pull_request_target:
    types: [opened, synchronize, labeled]
    paths: ['docs/**']
  issue_comment:
    types: [created]

jobs:
  # æ£€æµ‹ PR ä¸­çš„æ–‡æ¡£å˜æ›´
  detect-docs-changes:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      has-docs-changes: ${{ steps.changes.outputs.any_changed }}
      changed-files: ${{ steps.analyze.outputs.changed_files }}
      total-files: ${{ steps.analyze.outputs.total_files }}
      operation-summary: ${{ steps.analyze.outputs.operation_summary }}
      skip-comment: ${{ steps.check-skip.outputs.skip }}
    steps:
      - name: Check if should skip
        id: check-skip
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.payload.after;
            
            try {
              const { data: commit } = await github.rest.repos.getCommit({
                owner,
                repo,
                ref: sha,
              });
              const message = commit.commit.message;
              
              if (message.includes('ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡æ¡£')) {
                console.log('æ£€æµ‹åˆ°ç¿»è¯‘commitï¼Œè·³è¿‡æ–‡æ¡£å˜æ›´æ£€æµ‹å’Œè¯„è®º');
                core.setOutput('skip', 'true');
                return;
              }
              if (message.includes('ğŸ”„ æ’¤å›ç¿»è¯‘')) {
                console.log('æ£€æµ‹åˆ°æ’¤å›commitï¼Œè·³è¿‡æ–‡æ¡£å˜æ›´æ£€æµ‹å’Œè¯„è®º');
                core.setOutput('skip', 'true');
                return;
              }
            } catch (error) {
              console.error('æ£€æŸ¥commitå¤±è´¥:', error);
            }
            
            core.setOutput('skip', 'false');
      
      - uses: actions/checkout@v4
        if: steps.check-skip.outputs.skip != 'true'
        with:
          fetch-depth: 0
      
      - name: Check for docs changes
        id: changes
        if: steps.check-skip.outputs.skip != 'true'
        uses: tj-actions/changed-files@v40
        with:
          files: |
            docs/**/*.{md,mdx}
            docs/**/_category_.yml
          files_ignore: |
            docs/zh-CN/**
            docs/ja/**
            docs/Spanish/**
      
      - name: Analyze changes
        id: analyze
        if: steps.changes.outputs.any_changed == 'true' && steps.check-skip.outputs.skip != 'true'
        run: |
          echo "ğŸ“Š åˆ†ææ–‡æ¡£å˜æ›´..."
          
          base_sha="${{ github.event.pull_request.base.sha }}"
          echo "ğŸ” åŸºç¡€SHA: $base_sha"
          
          # ç»Ÿè®¡å˜æ›´
          added_count=0
          modified_count=0
          deleted_count=0
          renamed_count=0
          renamed_modified_count=0
          all_files=""
          
          if operations=$(git diff --name-status --find-renames=90 $base_sha..HEAD -- docs/ 2>/dev/null); then
            filtered_operations=$(echo "$operations" | grep -E '\.(md|mdx)$|_category_\.yml$' | grep -v -E '(zh-CN|ja|Spanish)' || true)
            
            if [[ -n "$filtered_operations" ]]; then
              while IFS=$'\t' read -r status file rest || [[ -n "$status" ]]; do
                [[ -z "$status" ]] && continue
                
                case "$status" in
                  A*) added_count=$((added_count + 1)); all_files="$all_files$file " ;;
                  M*) modified_count=$((modified_count + 1)); all_files="$all_files$file " ;;
                  D*) deleted_count=$((deleted_count + 1)); all_files="$all_files$file " ;;
                  R[0-9][0-9])
                    similarity=${status#R}
                    if [ "$similarity" -lt 100 ]; then
                      renamed_modified_count=$((renamed_modified_count + 1))
                    else
                      renamed_count=$((renamed_count + 1))
                    fi
                    all_files="$all_files$file "
                    [[ -n "$rest" ]] && all_files="$all_files$rest "
                    ;;
                  R*) renamed_count=$((renamed_count + 1)); all_files="$all_files$file "; [[ -n "$rest" ]] && all_files="$all_files$rest " ;;
                esac
              done <<< "$filtered_operations"
            fi
          fi
          
          total_count=$((added_count + modified_count + deleted_count + renamed_count + renamed_modified_count))
          
          echo "changed_files=$all_files" >> $GITHUB_OUTPUT
          echo "total_files=$total_count" >> $GITHUB_OUTPUT
          echo "operation_summary=æ–°å¢:$added_count ä¿®æ”¹:$modified_count åˆ é™¤:$deleted_count ç§»åŠ¨:$renamed_count ç§»åŠ¨+ä¿®æ”¹:$renamed_modified_count" >> $GITHUB_OUTPUT

  # æ·»åŠ ç¿»è¯‘æç¤ºè¯„è®ºï¼ˆåªåœ¨éç¿»è¯‘commitæ—¶æ·»åŠ ï¼‰
  add-translation-comment:
    needs: detect-docs-changes
    if: |
      needs.detect-docs-changes.outputs.has-docs-changes == 'true' &&
      needs.detect-docs-changes.outputs.skip-comment != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Add translation comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            
            const totalFiles = '${{ needs.detect-docs-changes.outputs.total-files }}';
            const operationSummary = '${{ needs.detect-docs-changes.outputs.operation-summary }}';
            
            let comment = `## ğŸŒ æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´ - å¯è¿›è¡Œå¤šè¯­è¨€ç¿»è¯‘\n\n`;
            comment += `**ç»Ÿè®¡ä¿¡æ¯:** å…± ${totalFiles} ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†\n`;
            comment += `**æ“ä½œç±»å‹:** ${operationSummary}\n\n`;
            
            comment += `### ğŸš€ å¼€å§‹ç¿»è¯‘\n`;
            comment += `åœ¨æ­¤è¯„è®ºå›å¤ä»¥ä¸‹å‘½ä»¤ä¹‹ä¸€ï¼š\n\n`;
            comment += `- \`/translate all\` - ç¿»è¯‘æ‰€æœ‰å˜æ›´åˆ°æ‰€æœ‰è¯­è¨€ (ä¸­æ–‡ã€æ—¥æ–‡ã€è¥¿ç­ç‰™è¯­)\n`;
            comment += `- \`/translate zh\` - ä»…ç¿»è¯‘åˆ°ä¸­æ–‡\n`;
            comment += `- \`/translate ja\` - ä»…ç¿»è¯‘åˆ°æ—¥æ–‡\n`;
            comment += `- \`/translate es\` - ä»…ç¿»è¯‘åˆ°è¥¿ç­ç‰™è¯­\n`;
            comment += `- \`/translate zh ja\` - ç¿»è¯‘åˆ°ä¸­æ–‡å’Œæ—¥æ–‡\n`;
            comment += `- \`/translate zh es\` - ç¿»è¯‘åˆ°ä¸­æ–‡å’Œè¥¿ç­ç‰™è¯­\n\n`;
            
            comment += `### ğŸ”„ æ’¤å›ç¿»è¯‘\n`;
            comment += `å¦‚æœå¯¹ç¿»è¯‘ç»“æœä¸æ»¡æ„ï¼Œå¯ä»¥ä½¿ç”¨ï¼š\n`;
            comment += `- \`/rollback translation\` - æ’¤å›æœ€è¿‘ä¸€æ¬¡çš„ç¿»è¯‘æäº¤\n\n`;
            
            comment += `### âš ï¸ æ³¨æ„äº‹é¡¹\n`;
            comment += `- åªæœ‰ä»“åº“ç®¡ç†å‘˜å’Œç»´æŠ¤è€…å¯ä»¥è§¦å‘ç¿»è¯‘å’Œæ’¤å›\n`;
            comment += `- æ’¤å›æ“ä½œä¼šæ¢å¤åˆ°ç¿»è¯‘å‰çš„çŠ¶æ€\n`;
            comment += `- æ¯æ¬¡æ“ä½œåä¼šè‡ªåŠ¨è§¦å‘æ„å»ºæ£€æŸ¥\n\n`;
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pull_number,
              body: comment
            });

  add-translation-comment-target:
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Comment with stats (safe for forks)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;

            // ç”¨ API è·å–å˜æ›´æ–‡ä»¶ï¼Œä¸ checkout PR ä»£ç ï¼ˆå®‰å…¨ï¼‰
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number, per_page: 100 }
            );

            // åªç»Ÿè®¡ docs/** ä¸‹çš„ md/mdx/_category_.yml ä¸”æ’é™¤ zh-CN/ja/Spanish
            const wanted = files.filter(f => {
              const p = f.filename;
              const inDocs = p.startsWith('docs/');
              const langExcluded = /(^|\/)(zh-CN|ja|Spanish)(\/|$)/.test(p);
              const okExt = /\.(md|mdx)$/.test(p) || /_category_\.yml$/.test(p);
              return inDocs && !langExcluded && okExt;
            });

            let added=0, modified=0, deleted=0, renamed=0, renamedModified=0;
            for (const f of wanted) {
              // f.status: 'added' | 'modified' | 'removed' | 'renamed'
              if (f.status === 'added') added++;
              else if (f.status === 'modified') modified++;
              else if (f.status === 'removed') deleted++;
              else if (f.status === 'renamed') {
                // API ä¸ç›´æ¥ç»™ç›¸ä¼¼åº¦ï¼Œç»Ÿä¸€ç®—åˆ° renamed
                renamed++;
              }
            }
            const total = added + modified + deleted + renamed + renamedModified;
            const summary = `æ–°å¢:${added} ä¿®æ”¹:${modified} åˆ é™¤:${deleted} ç§»åŠ¨:${renamed} ç§»åŠ¨+ä¿®æ”¹:${renamedModified}`;

            let body = `## ğŸŒ æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´ - å¯è¿›è¡Œå¤šè¯­è¨€ç¿»è¯‘\n\n`;
            body += `**ç»Ÿè®¡ä¿¡æ¯:** å…± ${total} ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†\n`;
            body += `**æ“ä½œç±»å‹:** ${summary}\n\n`;
            body += `### ğŸš€ å¼€å§‹ç¿»è¯‘\nåœ¨æ­¤è¯„è®ºå›å¤ä»¥ä¸‹å‘½ä»¤ä¹‹ä¸€ï¼š\n\n`;
            body += `- \`/translate all\` - ç¿»è¯‘æ‰€æœ‰å˜æ›´åˆ°æ‰€æœ‰è¯­è¨€ (ä¸­æ–‡ã€æ—¥æ–‡ã€è¥¿ç­ç‰™è¯­)\n`;
            body += `- \`/translate zh\` - ä»…ç¿»è¯‘åˆ°ä¸­æ–‡\n`;
            body += `- \`/translate ja\` - ä»…ç¿»è¯‘åˆ°æ—¥æ–‡\n`;
            body += `- \`/translate es\` - ä»…ç¿»è¯‘åˆ°è¥¿ç­ç‰™è¯­\n`;
            body += `- \`/translate zh ja\` - ç¿»è¯‘åˆ°ä¸­æ–‡å’Œæ—¥æ–‡\n`;
            body += `- \`/translate zh es\` - ç¿»è¯‘åˆ°ä¸­æ–‡å’Œè¥¿ç­ç‰™è¯­\n\n`;
            body += `### ğŸ”„ æ’¤å›ç¿»è¯‘\nå¦‚æœå¯¹ç¿»è¯‘ç»“æœä¸æ»¡æ„ï¼Œå¯ä»¥ä½¿ç”¨ï¼š\n- \`/rollback translation\` - æ’¤å›æœ€è¿‘ä¸€æ¬¡çš„ç¿»è¯‘æäº¤\n\n`;
            body += `### âš ï¸ æ³¨æ„äº‹é¡¹\n- åªæœ‰ä»“åº“ç®¡ç†å‘˜å’Œç»´æŠ¤è€…å¯ä»¥è§¦å‘ç¿»è¯‘å’Œæ’¤å›\n- æ’¤å›æ“ä½œä¼šæ¢å¤åˆ°ç¿»è¯‘å‰çš„çŠ¶æ€\n- æ¯æ¬¡æ“ä½œåä¼šè‡ªåŠ¨è§¦å‘æ„å»ºæ£€æŸ¥\n\n`;

            await github.rest.issues.createComment({
              owner, repo, issue_number: pull_number, body
            });

  # æ‰‹åŠ¨è§¦å‘ç¿»è¯‘
  manual-translate:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/translate')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      translation-completed: ${{ steps.check-completion.outputs.completed }}
      has-changes: ${{ steps.check-completion.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.TRANSLATION_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          clean: true  # ç¡®ä¿å·¥ä½œåŒºå¹²å‡€
      
      - name: Add start comment
        id: start-comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const username = context.payload.comment.user.login;
            
            const comment = `## ğŸ”„ å¼€å§‹ç¿»è¯‘ä»»åŠ¡\n\n` +
              `**è§¦å‘è€…:** @${username}\n` +
              `**å¼€å§‹æ—¶é—´:** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n` +
              `**å‘½ä»¤:** \`${context.payload.comment.body.trim()}\`\n\n` +
              `â³ æ­£åœ¨æ£€æŸ¥æƒé™å’Œåˆå§‹åŒ–ç¿»è¯‘ç¯å¢ƒ...\n\n` +
              `> ğŸ” ç¿»è¯‘å®Œæˆåä¼šåœ¨æ­¤æ›´æ–°è¯¦ç»†æŠ¥å‘Š`;
            
            const response = await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: comment
            });
            
            return response.data.id;
      
      - name: Check user permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const username = context.payload.comment.user.login;
            
            console.log(`æ£€æŸ¥ç”¨æˆ·æƒé™: ${username}`);
            
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner,
                repo,
                username
              });
              
              const allowedRoles = ['admin', 'maintain'];
              const hasPermission = allowedRoles.includes(permission.permission);
              
              console.log(`ç”¨æˆ· ${username} çš„æƒé™çº§åˆ«: ${permission.permission}`);
              console.log(`æ˜¯å¦æœ‰ç¿»è¯‘æƒé™: ${hasPermission}`);
              
              if (!hasPermission) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: context.payload.issue.number,
                  body: `## âŒ æƒé™ä¸è¶³\n\n` +
                    `@${username} æƒé™ä¸è¶³ï¼Œåªæœ‰ä»“åº“ç®¡ç†å‘˜å’Œç»´æŠ¤è€…å¯ä»¥è§¦å‘ç¿»è¯‘ã€‚\n\n` +
                    `**å½“å‰æƒé™çº§åˆ«:** \`${permission.permission}\`\n` +
                    `**éœ€è¦æƒé™çº§åˆ«:** \`admin\` æˆ– \`maintain\`\n\n` +
                    `è¯·è”ç³»ä»“åº“ç®¡ç†å‘˜è·å–ç›¸åº”æƒé™ã€‚`
                });
                
                core.setFailed(`ç”¨æˆ· ${username} æƒé™ä¸è¶³`);
                return;
              }
              
              core.setOutput('has_permission', 'true');
              
            } catch (error) {
              console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.payload.issue.number,
                body: `## âŒ æƒé™æ£€æŸ¥å¤±è´¥\n\n` +
                  `æ— æ³•éªŒè¯ @${username} çš„æƒé™ã€‚è¯·ç¡®ä¿ç”¨æˆ·æ˜¯ä»“åº“çš„åä½œè€…ã€‚\n\n` +
                  `**é”™è¯¯ä¿¡æ¯:** ${error.message}\n\n` +
                  `è¯·è”ç³»ä»“åº“ç®¡ç†å‘˜è§£å†³æ­¤é—®é¢˜ã€‚`
              });
              
              core.setFailed(`æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
      
      - name: Checkout PR
        if: steps.check-permissions.outputs.has_permission == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.TRANSLATION_PAT || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.TRANSLATION_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“„ åˆ‡æ¢åˆ°PRåˆ†æ”¯..."
          gh pr checkout ${{ github.event.issue.number }}
          
          # è®°å½•ç¿»è¯‘å‰çš„commit SHAï¼Œç”¨äºæ½œåœ¨çš„æ’¤å›æ“ä½œ
          BEFORE_TRANSLATION_SHA=$(git rev-parse HEAD)
          echo "BEFORE_TRANSLATION_SHA=$BEFORE_TRANSLATION_SHA" >> $GITHUB_ENV
          echo "ğŸ“Œ è®°å½•ç¿»è¯‘å‰çš„SHA: $BEFORE_TRANSLATION_SHA"
      
      - name: Setup Node.js
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Parse translation command
        if: steps.check-permissions.outputs.has_permission == 'true'
        id: parse
        run: |
          comment="${{ github.event.comment.body }}"
          echo "ğŸ” è§£æç¿»è¯‘å‘½ä»¤: $comment"
          
          if [[ "$comment" == *"/translate all"* ]]; then
            languages="zh-CN ja es"
            echo "ğŸŒ ç¿»è¯‘åˆ°æ‰€æœ‰è¯­è¨€: ä¸­æ–‡ã€æ—¥æ–‡ã€è¥¿ç­ç‰™è¯­"
          else
            languages=""
            [[ "$comment" == *" zh"* ]] && languages="$languages zh-CN" && echo "ğŸ‡¨ğŸ‡³ æ·»åŠ ä¸­æ–‡ç¿»è¯‘"
            [[ "$comment" == *" ja"* ]] && languages="$languages ja" && echo "ğŸ‡¯ğŸ‡µ æ·»åŠ æ—¥æ–‡ç¿»è¯‘"
            [[ "$comment" == *" es"* ]] && languages="$languages es" && echo "ğŸ‡ªğŸ‡¸ æ·»åŠ è¥¿ç­ç‰™è¯­ç¿»è¯‘"
          fi
          
          languages=$(echo $languages | xargs)
          echo "languages=$languages" >> $GITHUB_OUTPUT
          echo "ğŸ¯ æœ€ç»ˆç¿»è¯‘è¯­è¨€: $languages"
      
      - name: Get PR base SHA
        if: steps.check-permissions.outputs.has_permission == 'true'
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.TRANSLATION_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“Š è·å–PRåŸºç¡€ä¿¡æ¯..."
          base_sha=$(gh pr view ${{ github.event.issue.number }} --json baseRefOid --jq '.baseRefOid')
          echo "base_sha=$base_sha" >> $GITHUB_OUTPUT
          echo "ğŸ” åŸºç¡€SHA: $base_sha"
      
      - name: Install dependencies
        if: steps.check-permissions.outputs.has_permission == 'true'
        run: |
          echo "ğŸ“¦ å®‰è£…ç¿»è¯‘ä¾èµ–..."
          npm install @anthropic-ai/sdk --no-save --legacy-peer-deps
      
      - name: Run translation
        if: steps.check-permissions.outputs.has_permission == 'true'
        env:
          TRANSLATION_API_KEY: ${{ secrets.TRANSLATION_API_KEY }}
          TARGET_LANGUAGES: ${{ steps.parse.outputs.languages }}
          BASE_SHA: ${{ steps.pr-info.outputs.base_sha }}
        run: |
          echo "ğŸš€ å¼€å§‹ç¿»è¯‘ä»»åŠ¡..."
          echo "ç›®æ ‡è¯­è¨€: $TARGET_LANGUAGES"
          echo "åŸºç¡€SHA: $BASE_SHA"
          
          if [ -z "$TRANSLATION_API_KEY" ]; then
            echo "âŒ é”™è¯¯: ç¼ºå°‘TRANSLATION_API_KEYï¼Œè¯·åœ¨ä»“åº“Settings > Secretsä¸­é…ç½®"
            exit 1
          fi
          
          node .github/scripts/translate.js
      
      - name: Commit and push changes
        if: steps.check-permissions.outputs.has_permission == 'true'
        env:
          TRANSLATION_PAT: ${{ secrets.TRANSLATION_PAT }}
          LANGUAGES: ${{ steps.parse.outputs.languages }}
          TRIGGERED_BY: ${{ github.event.comment.user.login }}
        run: |
          echo "ğŸ”„ æäº¤ç¿»è¯‘ç»“æœ..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "ğŸ“‹ å½“å‰gitçŠ¶æ€ï¼š"
          git status --short
          
          # é‡ç½®ä¸éœ€è¦çš„æ–‡ä»¶ä¿®æ”¹ï¼ˆå¦‚yarn.lockï¼‰
          git checkout -- yarn.lock package-lock.json 2>/dev/null || true
          
          # æ£€æŸ¥docsç›®å½•æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain docs/)" ]; then
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            
            # æ·»åŠ docsç›®å½•çš„æ›´æ”¹
            git add docs/
            
            # åˆ›å»ºcommit message
            COMMIT_MSG="ğŸŒ è‡ªåŠ¨ç¿»è¯‘æ–‡æ¡£"
            COMMIT_DETAILS="Translation Languages: ${LANGUAGES}
          Before Translation SHA: ${BEFORE_TRANSLATION_SHA}
          Triggered by: @${TRIGGERED_BY}
          Time: $(date '+%Y-%m-%d %H:%M:%S')"
            
            # æäº¤æ›´æ”¹
            git commit -m "$COMMIT_MSG" -m "$COMMIT_DETAILS"
            
            # ä½¿ç”¨PATæ¨é€ä»¥è§¦å‘å…¶ä»–å·¥ä½œæµ
            if [ -n "$TRANSLATION_PAT" ]; then
              echo "ä½¿ç”¨PATæ¨é€..."
              git push https://${TRANSLATION_PAT}@github.com/${{ github.repository }}.git HEAD
            else
              echo "ä½¿ç”¨é»˜è®¤tokenæ¨é€..."
              git push origin HEAD
            fi
            
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
            echo "TRANSLATION_COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
            echo "âœ… ç¿»è¯‘ç»“æœå·²æäº¤å¹¶æ¨é€"
          else
            echo "â„¹ï¸ æ²¡æœ‰ç¿»è¯‘å†…å®¹éœ€è¦æäº¤"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          fi
      
      - name: Save translation metadata
        if: steps.check-permissions.outputs.has_permission == 'true' && env.HAS_CHANGES == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.issue.number;
            
            // ä¿å­˜ç¿»è¯‘å…ƒæ•°æ®åˆ°PRçš„commentä¸­ï¼ˆéšè—çš„metadataï¼‰
            const metadata = {
              before_sha: process.env.BEFORE_TRANSLATION_SHA,
              after_sha: process.env.TRANSLATION_COMMIT_SHA,
              languages: '${{ steps.parse.outputs.languages }}',
              timestamp: new Date().toISOString(),
              triggered_by: '${{ github.event.comment.user.login }}'
            };
            
            const metadataComment = `<!-- TRANSLATION_METADATA
            ${JSON.stringify(metadata)}
            -->`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: metadataComment
            });
      
      - name: Check completion status
        id: check-completion
        if: always() && steps.check-permissions.outputs.has_permission == 'true'
        run: |
          if [ "${{ job.status }}" = "success" ] && [ "$HAS_CHANGES" = "true" ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… ç¿»è¯‘å®Œæˆä¸”æœ‰å†…å®¹å˜æ›´"
          else
            echo "completed=false" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ç¿»è¯‘æœªå®Œæˆæˆ–æ— å†…å®¹å˜æ›´"
          fi

      - name: Update completion comment
        if: always() && steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const commentId = '${{ steps.start-comment.outputs.result }}';
            
            const success = '${{ job.status }}' === 'success';
            const languages = '${{ steps.parse.outputs.languages }}';
            const hasChanges = process.env.HAS_CHANGES === 'true';
            const translationSha = process.env.TRANSLATION_COMMIT_SHA || 'N/A';
            const beforeSha = process.env.BEFORE_TRANSLATION_SHA || 'N/A';
            
            let status, statusIcon;
            if (success && hasChanges) {
              status = 'ç¿»è¯‘å®Œæˆ';
              statusIcon = 'âœ…';
            } else if (success && !hasChanges) {
              status = 'æ— éœ€ç¿»è¯‘';
              statusIcon = 'â„¹ï¸';
            } else {
              status = 'ç¿»è¯‘å¤±è´¥';
              statusIcon = 'âŒ';
            }
            
            let comment = `## ${statusIcon} ${status}\n\n`;
            comment += `**ç¿»è¯‘è¯­è¨€:** ${languages || 'æ— '}\n`;
            comment += `**å®Œæˆæ—¶é—´:** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n`;
            comment += `**è§¦å‘è€…:** @${{ github.event.comment.user.login }}\n`;
            
            if (success && hasChanges) {
              comment += `**ç¿»è¯‘å‰SHA:** \`${beforeSha}\`\n`;
              comment += `**ç¿»è¯‘åSHA:** \`${translationSha}\`\n\n`;
              
              comment += `### ğŸ‰ ç¿»è¯‘æˆåŠŸï¼\n\n`;
              comment += `ç¿»è¯‘æ–‡ä»¶å·²è‡ªåŠ¨æäº¤åˆ°å½“å‰PRåˆ†æ”¯ã€‚\n\n`;
              
              comment += `### ğŸ”„ åç»­æ“ä½œ\n`;
              comment += `- å¦‚æœå¯¹ç¿»è¯‘ç»“æœä¸æ»¡æ„ï¼Œå¯ä»¥ä½¿ç”¨ \`/rollback translation\` æ’¤å›æ­¤æ¬¡ç¿»è¯‘\n`;
              comment += `- æ’¤å›åå¯ä»¥é‡æ–°ç¿»è¯‘æˆ–æ‰‹åŠ¨ä¿®æ”¹\n\n`;
              
            } else if (success && !hasChanges) {
              comment += `### ğŸ” æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦ç¿»è¯‘çš„å†…å®¹\n\n`;
              comment += `å¯èƒ½çš„åŸå› ï¼š\n`;
              comment += `- ç›®æ ‡è¯­è¨€çš„ç¿»è¯‘æ–‡ä»¶å·²ç»æ˜¯æœ€æ–°çš„\n`;
              comment += `- æ²¡æœ‰æ£€æµ‹åˆ°æœ‰æ•ˆçš„æ–‡æ¡£å˜æ›´\n\n`;
            } else {
              comment += `### ğŸ’” ç¿»è¯‘å¤±è´¥\n\n`;
              comment += `è¯·æŸ¥çœ‹ [å·¥ä½œæµæ—¥å¿—](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚\n\n`;
            }
            
            // è¯»å–è¯¦ç»†æŠ¥å‘Šï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            try {
              const fs = require('fs');
              if (fs.existsSync('/tmp/translation-report.md')) {
                const report = fs.readFileSync('/tmp/translation-report.md', 'utf8');
                comment += `### ğŸ“Š è¯¦ç»†æŠ¥å‘Š\n\n${report}`;
              }
            } catch (error) {
              console.log('æ— æ³•è¯»å–è¯¦ç»†æŠ¥å‘Š:', error.message);
            }
            
            comment += `\n---\n> ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | [æŸ¥çœ‹å·¥ä½œæµ](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})`;
            
            // æ›´æ–°åŸå§‹è¯„è®º
            try {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: commentId,
                body: comment
              });
            } catch (error) {
              console.log('æ›´æ–°è¯„è®ºå¤±è´¥ï¼Œåˆ›å»ºæ–°è¯„è®º:', error.message);
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: comment
              });
            }

  # æ’¤å›ç¿»è¯‘æ“ä½œ
  rollback-translation:
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/rollback translation')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.TRANSLATION_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Check user permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const username = context.payload.comment.user.login;
            
            console.log(`æ£€æŸ¥ç”¨æˆ·æƒé™: ${username}`);
            
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner,
                repo,
                username
              });
              
              const allowedRoles = ['admin', 'maintain'];
              const hasPermission = allowedRoles.includes(permission.permission);
              
              if (!hasPermission) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: context.payload.issue.number,
                  body: `## âŒ æƒé™ä¸è¶³\n\n` +
                    `@${username} æ²¡æœ‰æ’¤å›ç¿»è¯‘çš„æƒé™ã€‚åªæœ‰ç®¡ç†å‘˜å’Œç»´æŠ¤è€…å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œã€‚`
                });
                core.setFailed('æƒé™ä¸è¶³');
                return;
              }
              
              core.setOutput('has_permission', 'true');
              
            } catch (error) {
              console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
              core.setFailed(`æƒé™æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
      
      - name: Find translation metadata
        id: find-metadata
        if: steps.check-permissions.outputs.has_permission == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            
            // è·å–æ‰€æœ‰è¯„è®º
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100
            });
            
            // æŸ¥æ‰¾æœ€æ–°çš„ç¿»è¯‘å…ƒæ•°æ®
            let latestMetadata = null;
            const metadataRegex = /<!-- TRANSLATION_METADATA\s+(.*?)\s+-->/s;
            
            for (const comment of comments.data.reverse()) {
              const match = comment.body.match(metadataRegex);
              if (match) {
                try {
                  latestMetadata = JSON.parse(match[1]);
                  console.log('æ‰¾åˆ°ç¿»è¯‘å…ƒæ•°æ®:', latestMetadata);
                  break;
                } catch (e) {
                  console.error('è§£æå…ƒæ•°æ®å¤±è´¥:', e);
                }
              }
            }
            
            if (!latestMetadata) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `## âš ï¸ æœªæ‰¾åˆ°ç¿»è¯‘è®°å½•\n\næ²¡æœ‰æ‰¾åˆ°å¯ä»¥æ’¤å›çš„ç¿»è¯‘æ“ä½œã€‚`
              });
              core.setFailed('æœªæ‰¾åˆ°ç¿»è¯‘å…ƒæ•°æ®');
              return;
            }
            
            core.setOutput('before_sha', latestMetadata.before_sha);
            core.setOutput('after_sha', latestMetadata.after_sha);
            core.setOutput('languages', latestMetadata.languages);
            core.setOutput('has_metadata', 'true');
      
      - name: Checkout PR and rollback
        if: steps.find-metadata.outputs.has_metadata == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.TRANSLATION_PAT || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.TRANSLATION_PAT || secrets.GITHUB_TOKEN }}
          TRANSLATION_PAT: ${{ secrets.TRANSLATION_PAT }}
        run: |
          echo "ğŸ“„ åˆ‡æ¢åˆ°PRåˆ†æ”¯..."
          gh pr checkout ${{ github.event.issue.number }}
          
          BEFORE_SHA="${{ steps.find-metadata.outputs.before_sha }}"
          AFTER_SHA="${{ steps.find-metadata.outputs.after_sha }}"
          
          echo "ğŸ”„ å‡†å¤‡æ’¤å›ç¿»è¯‘..."
          echo "  ç¿»è¯‘å‰SHA: $BEFORE_SHA"
          echo "  ç¿»è¯‘åSHA: $AFTER_SHA"
          echo "  å½“å‰SHA: $(git rev-parse HEAD)"
          
          # æ£€æŸ¥å½“å‰commitæ˜¯å¦æ˜¯ç¿»è¯‘commit
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" != "$AFTER_SHA" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šå½“å‰HEADä¸æ˜¯æœ€åä¸€æ¬¡ç¿»è¯‘çš„commitï¼Œå¯èƒ½æœ‰å…¶ä»–æ›´æ”¹"
            echo "ç»§ç»­æ’¤å›åˆ°ç¿»è¯‘å‰çš„çŠ¶æ€..."
          fi
          
          # æ‰§è¡Œæ’¤å›
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # ä½¿ç”¨reset --hardå›åˆ°ç¿»è¯‘å‰çš„çŠ¶æ€
          git reset --hard $BEFORE_SHA
          
          # å¼ºåˆ¶æ¨é€ï¼ˆéœ€è¦PATï¼‰
          if [ -n "$TRANSLATION_PAT" ]; then
            echo "ä½¿ç”¨PATå¼ºåˆ¶æ¨é€..."
            git push --force https://${TRANSLATION_PAT}@github.com/${{ github.repository }}.git HEAD
          else
            echo "ä½¿ç”¨é»˜è®¤tokenå¼ºåˆ¶æ¨é€..."
            git push --force origin HEAD
          fi
          
          echo "âœ… å·²æ’¤å›åˆ°ç¿»è¯‘å‰çš„çŠ¶æ€"

      - name: Add rollback marker commit
        if: steps.find-metadata.outputs.has_metadata == 'true'
        env:
          TRANSLATION_PAT: ${{ secrets.TRANSLATION_PAT }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # æ–°å»ºä¸€ä¸ªç©º commit ä½œä¸ºæ ‡è®°
          git commit --allow-empty -m "ğŸ”„ æ’¤å›ç¿»è¯‘"
          
          if [ -n "$TRANSLATION_PAT" ]; then
            echo "ä½¿ç”¨PATæ¨é€ rollback æ ‡è®° commit..."
            git push https://${TRANSLATION_PAT}@github.com/${{ github.repository }}.git HEAD
          else
            git push origin HEAD
          fi
      
      - name: Post rollback comment
        if: steps.find-metadata.outputs.has_metadata == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.payload.issue.number;
            const username = context.payload.comment.user.login;
            
            const beforeSha = '${{ steps.find-metadata.outputs.before_sha }}';
            const afterSha = '${{ steps.find-metadata.outputs.after_sha }}';
            const languages = '${{ steps.find-metadata.outputs.languages }}';
            
            let comment = `## âœ… ç¿»è¯‘å·²æ’¤å›\n\n`;
            comment += `**æ“ä½œè€…:** @${username}\n`;
            comment += `**æ’¤å›æ—¶é—´:** ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n`;
            
            comment += `### ğŸ“‹ æ’¤å›è¯¦æƒ…\n`;
            comment += `- **æ’¤å›çš„ç¿»è¯‘è¯­è¨€:** ${languages}\n`;
            comment += `- **æ¢å¤åˆ°çš„SHA:** \`${beforeSha}\`\n`;
            comment += `- **æ’¤å›çš„SHA:** \`${afterSha}\`\n\n`;
            
            comment += `### ğŸ”„ åç»­æ“ä½œ\n`;
            comment += `- ç°åœ¨å¯ä»¥é‡æ–°è¿›è¡Œç¿»è¯‘æˆ–æ‰‹åŠ¨ä¿®æ”¹æ–‡æ¡£\n`;
            comment += `- ä½¿ç”¨ \`/translate [è¯­è¨€]\` é‡æ–°ç¿»è¯‘\n\n`;
            
            comment += `---\n> ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ`;
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: comment
            });
            
            // åˆ é™¤æ—§çš„å…ƒæ•°æ®comment
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100
            });
            
            const metadataRegex = /<!-- TRANSLATION_METADATA/;
            for (const comment of comments.data) {
              if (metadataRegex.test(comment.body)) {
                await github.rest.issues.deleteComment({
                  owner,
                  repo,
                  comment_id: comment.id
                });
                console.log(`åˆ é™¤äº†æ—§çš„å…ƒæ•°æ®comment: ${comment.id}`);
                break;
              }
            }

  post-merge-comment:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Comment after merge (mimic Issue Auto Comment)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const pr_number = pr.number;
            const author = pr.user.login;

            const body = `â¤ï¸ Great PR @${author} â¤ï¸`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body
            });